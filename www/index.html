<html>
<style>
  body {
    margin: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    overflow: hidden;
    background-color: #333;
  }

  @media (max-aspect-ratio: 16/9) {
    .landscape #preview {
      width: 100%;
      overflow-y: scroll;
    }
  }

  @media (min-aspect-ratio: 16/9) {
    .landscape #preview {
      height: 100%;
      overflow-x: scroll;
    }
  }

  @media (max-aspect-ratio: 9/16) {
    .portrait #preview {
      width: 100%;
      overflow-y: scroll;
    }
  }

  @media (min-aspect-ratio: 9/16) {
    .portrait #preview {
      height: 100%;
      overflow-x: scroll;
    }
  }

  #menu {
    position: fixed;
    left: 0.2em;
    right: 1em;
    z-index: 2;
    width: min-content;
  }

  #menu > icon {
    opacity: 0.5;
  }

  icon {
    display: inline-block;
    font-size: calc(3vw + 3vh);
    padding-top: 1vh;
  }

  #moreToggle {
    font-size: 3em;
    color: white;
    background-color: rgba(0, 0, 0, 0.5);
    display: inline-block;
    position: fixed;
    top: 0.2em;
    right: 0.2em;
    padding: 0px 0.3em 0.15em;
  }

  #more {
    color: white;
    background-color: rgba(0, 0, 0, 0.3);
    position: absolute;
    bottom: 0;
    width: 100%;
    z-index: 3;
    text-align: center;
    font-size: 3em;
  }

  #more * {
    font-size: inherit;
  }

  a {
    color: inherit;
    text-decoration: inherit;
  }
</style>

<body>
  <icon id="moreToggle" onclick="toggleMore()">&#8942;</icon>
  <div id="menu">
    <icon id="/preview/" onclick="setPreviewSrc(this.id)">&#128250;</icon>
    <icon id="/lastframe/" onclick="setPreviewSrc(this.id)">&#9209;</icon>
    <icon id="/timelapse/" onclick="showTimelapse(false)">&#9193;</icon>
    <!--icon id="/timelapse/?reverse=1" onclick="showTimelapse(true)">&#9194;</icon-->
    <a href="/photo/" download="obscura.jpg">
      <icon>&#128247;</icon>
    </a>
  </div>
  <div style="height: 100%; width: 100%; text-align: center;">
    <img id="preview" src="/lastframe">
  </div>
  <div id="more" style="display: none;">
    <input id="at" type='range' step=60 style="width: 100%; display: block;">
    <div id="when" style='text-align: center;'></div>
    <div>
      Speed: <input id="speed" type='number' style='width: 3em'>
      <select id="units">
        <option value=60>minutes</option>
        <option value=3600>hours</option>
        <option value=86400>days</option>
      </select>
      fps: <input id="fps" value="12" type='number' style='width: 3em'>
    </div>
    <div>
      <icon onclick="changeSettings('rotate')">&#128260;</icon>
      <icon onclick="changeSettings('hmirror')">&#128257;</icon>
      <icon onclick="changeSettings('vmirror')">&#128259;</icon>
      <icon onclick="changeSettings('landscape')">&#128256;</icon>
    </div>
  </div>
</body>
<script>
  async function changeSettings(reason) {
    const info = await fetch('/settings/?' + reason).then(r => r.json());
    document.body.classList[info.config.landscape ? 'add' : 'remove']('landscape');
    document.body.classList[info.config.landscape ? 'remove' : 'add']('portrait');
    setPreviewSrc('/preview/');
  }
  function sleep(seconds) {
    if (seconds > 0)
      return new Promise(resolve => setTimeout(resolve, seconds * 1000));
    return Promise.resolve();
  }

  function setPreviewSrc(src) {
    const preview = document.getElementById('preview');
    preview.onload = preview.onerror = () => preview.isLoading = false;
    preview.isLoading = true;
    preview.src = src;
  }

  async function showTimelapse(f) {
    const units = +document.getElementById('units').value;
    const speed = +document.getElementById('speed').value;
    const fps = +document.getElementById('fps').value;
    const at = +document.getElementById('at').value;
    const when = document.getElementById('when');
    const preview = document.getElementById('preview');
    setPreviewSrc("/timelapse/?since=" + at * 1000
      + "&speed=" + (units * speed * (f ? -1 : 1))
      + "&fps=" + fps)
  }
  async function initMoreInfo() {
    const info = await fetch("/info").then(resp => resp.json());
    document.body.classList[info.config.landscape ? 'add' : 'remove']('landscape');
    document.body.classList[info.config.landscape ? 'remove' : 'add']('portrait');
    const units = document.getElementById('units');
    const speed = document.getElementById('speed');
    if (info.config.timelapse.speed < 3600)
      units.value = 60;
    else if (info.config.timelapse.speed < 86400)
      units.value = 3600;
    else
      units.value = 86400;
    speed.value = info.config.timelapse.speed / units.value;
    at.min = info.startFrame;
    at.max = at.max = Math.floor(Date.now() / 1000);
  }
  async function toggleMore(flag) {
    const e = document.getElementById("more");
    const at = e.children.at;
    if (flag === false || !e.style.display) {
      e.style.display = "none";
      at.oninput = null;
    } else {
      e.style.display = "";
      await initMoreInfo();
      function updatePreview() {
        const when = new Date(at.value * 1000);
        const preview = document.getElementById("preview");

        if (!preview.isLoading) {
          setPreviewSrc("/at.jpg?t=" + when.getTime());
          e.children.when.textContent = when.toString().substring(0, 25);
        }
      }
      at.oninput = updatePreview;
      updatePreview();
    }
  }
  initMoreInfo();
</script>

</html>